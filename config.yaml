# ==============================================================
#
#   Mihomo é«˜çº§è®¢é˜…è½¬æ¢æ¨¡æ¿ (CommonDist ç²¾ç»†æ¨¡å¼)
#
#   è§„åˆ™æº: CommonDist/NewRules (å·²é‡‡ç”¨å­ç›®å½•ç²¾ç»†è§„åˆ™)
#   è¯´æ˜:
#     - æœ¬é…ç½®å·²å®Œå…¨æŒ‰ç…§ CommonDist/NewRules çš„é«˜çº§ç”¨æ³•æ„å»ºï¼Œ
#       é€šè¿‡å¼•ç”¨å­ç›®å½•ä¸‹çš„ç»†åˆ†è§„åˆ™ï¼Œå®ç°äº†å¯¹ä¸åŒåº”ç”¨ç±»å‹çš„ç²¾ç¡®åˆ†æµã€‚
#     - è¿™æ˜¯å®ç°å¤æ‚åˆ†æµç­–ç•¥çš„æœ€ç»ˆã€æœ€æ­£ç¡®ç‰ˆæœ¬ã€‚
#
# ==============================================================

# èŠ‚ç‚¹è®¢é˜… / æ¨¡æ¿å ä½ç¬¦
proxy-providers:
  main-subscription:
    type: http
    url: "URL_PLACEHOLDER"
    interval: 86400 # 24å°æ—¶æ›´æ–°ä¸€æ¬¡
    path: ./proxies/main.yaml
    health-check:
      enable: true
      interval: 600 # 10åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
      url: https://www.gstatic.com/generate_204

# åŸºç¡€é…ç½®
port: 7890
socks-port: 7891
redir-port: 7892
mixed-port: 7893
tproxy-port: 7895
bind-address: "*"
ipv6: true

allow-lan: true
mode: rule
log-level: warning

unified-delay: true
tcp-concurrent: true
external-controller: 0.0.0.0:9090
secret: ""
external-ui: "/usr/share/openclash/ui"
external-ui-name: metacubexd
keep-alive-interval: 15
keep-alive-idle: 600

geodata-mode: true
geodata-loader: standard
geox-url:
  mmdb: https://testingcf.jsdelivr.net/gh/alecthw/mmdb_china_ip_list@release/lite/Country.mmdb
  geoip: https://testingcf.jsdelivr.net/gh/Loyalsoldier/v2ray-rules-dat@release/geoip.dat
  geosite: https://testingcf.jsdelivr.net/gh/Loyalsoldier/v2ray-rules-dat@release/geosite.dat
  asn: https://testingcf.jsdelivr.net/gh/xishang0128/geoip@release/GeoLite2-ASN.mmdb
geo-auto-update: false # æ˜¯å¦è‡ªåŠ¨æ›´æ–° geodata
geo-update-interval: 24 # æ›´æ–°é—´éš”ï¼Œå•ä½ï¼šå°æ—¶

# ========================
# DNS è®¾ç½® (Fake-IP æ¨¡å¼)
# ========================

dns:
  enable: true
  listen: 0.0.0.0:7874
  ipv6: false                     # å…³é—­ IPv6 ä¸Šæ¸¸ï¼Œé¿å… ISP é»˜è®¤ IPv6 DNS æ³„éœ²
  enhanced-mode: fake-ip          # fake-ip æ¨¡å¼ï¼Œæœç» DNS æ³„éœ²
  fake-ip-range: 198.18.0.1/16    # fake-ip åˆ†é…èŒƒå›´
  use-hosts: true                  # å¯ç”¨ hosts æ–‡ä»¶è§£æä¼˜å…ˆ

  # å…¨å±€é»˜è®¤ DNSï¼ˆæœªåŒ¹é…è§„åˆ™åŸŸåèµ°è¿™é‡Œï¼‰
  nameserver:
    - https://doh.opendns.com/dns-query    # OpenDNS DoH
    - https://dns.google/dns-query         # Google DoHï¼Œå›½é™…è§£æå¯é 
    - https://cloudflare-dns.com/dns-query # Cloudflare DoHï¼Œå›½é™…è§£æé«˜éšç§
    - https://dns.quad9.net/dns-query      # Quad9 DoHï¼Œå›½é™…å®‰å…¨å®¹é”™

  # ç²¾å‡†åŸŸååˆ†æµç­–ç•¥
  nameserver-policy:
    # å›½å†…åŸŸååˆ†æµ
    'geosite:cn':
      - https://doh.pub/dns-query         # è…¾è®¯ DoHï¼Œå›½å†…ä¼˜åŒ–
      - https://dns.alidns.com/dns-query  # é˜¿é‡Œ DoHï¼Œé«˜é€Ÿç¨³å®š

      # DoT (DNS over TLS) 
      - tls://dot.pub:853                 # è…¾è®¯ DoH
      - tls://223.5.5.5:853               # é˜¿é‡Œ DoT IPv4ï¼Œå¤‡ç”¨æ˜æ–‡é˜»æ–­ ISP åŠ«æŒ
      - tls://223.6.6.6:853               # é˜¿é‡Œ DoT å¤‡ç”¨

    # å›½å¤–åŸŸååˆ†æµï¼ˆæ˜¾å¼å£°æ˜ï¼Œæå‡é…ç½®æ¸…æ™°åº¦ï¼Œå¯æ‰©å±•ï¼‰
    'geosite:geolocation-!cn':
      - https://doh.opendns.com/dns-query    # OpenDNS DoH
      - https://cloudflare-dns.com/dns-query # Cloudflare DoH
      - https://dns.google/dns-query         # Google DoH
      - https://dns.quad9.net/dns-query      # Quad9 DoHï¼Œå®‰å…¨å®¹é”™

  # Fake-IP è¿‡æ»¤å™¨ï¼Œé¿å…å±€åŸŸç½‘ã€ä¿ç•™åœ°å€è¢« fake-ip è§£æ
  fake-ip-filter:
    - '*.lan'         # å±€åŸŸç½‘åŸŸå
    - '*.local'       # æœ¬åœ°ç½‘ç»œ
    - '*.localhost'   # æœ¬åœ°ä¸»æœº

# ========================
# TUN æ¨¡å—
# ========================

tun:
  enable: true
  stack: system
  device: utun
  dns-hijack: ["any:53", "tcp://any:53"]
  endpoint-independent-nat: true
  auto-route: true
  auto-detect-interface: true
  auto-redirect: false
  strict-route: true  # ä¸¥æ ¼è·¯ç”±ï¼Œä¿è¯æµé‡èµ° TUN

sniffer:
  enable: true
  override-destination: true
  sniff:
    QUIC: { ports: [443] }
    TLS: { ports: [443, 8443] }
    HTTP: { ports: [80, '8080-8880'], override-destination: true }

  # å¼ºåˆ¶å—…æ¢åŸŸåï¼ˆå¦‚è§†é¢‘ã€æµåª’ä½“ï¼‰
  force-domain:
  - "+.netflix.com"
  - "+.nflxvideo.net"
  - "+.amazonaws.com"
  - "+.media.dssott.com"

  # è·³è¿‡å—…æ¢çš„åŸŸåï¼ˆå±€åŸŸç½‘/ç‰¹æ®ŠæœåŠ¡ï¼‰
  skip-domain:
  - "+.apple.com"
  - Mijia Cloud
  - dlg.io.mi.com
  - "+.oray.com"
  - "+.sunlogin.net"
  - "+.push.apple.com"
  parse-pure-ip: true  # ç›´æ¥è§£æçº¯ IP æµé‡

profile:
  store-selected: true
  store-fake-ip: true
  bootstrap-dns:
    - 119.229.29.29     # è…¾è®¯DNSï¼Œ~10ms (å›½å†…æœ€å¿«ï¼Œä¿è¯åŸºç¡€å¯ç”¨æ€§)
    - 208.67.222.222    # OpenDNSï¼Œ~14ms (å›½é™…æœ€å¿«ï¼Œæ€§èƒ½å“è¶Š)
    - 223.5.5.5         # é˜¿é‡ŒDNSï¼Œ~15ms (å›½å†…å¤‡ç”¨ï¼Œå¢åŠ å®¹é”™)
    - 8.8.8.8           # Googleï¼Œ~41ms (å›½é™…å¤‡ç”¨ï¼Œé«˜å¯é æ€§)
    - 9.9.9.9           # Quad9ï¼Œå¯è¾¾ï¼Œå¤‡ç”¨
    - 208.67.220.220    # OpenDNS å¤‡ç”¨ï¼Œå¢åŠ å¤šæ ·æ€§
    - 1.0.0.1           # Cloudflareï¼Œå¯è¾¾ï¼Œå¤‡ç”¨

authentication:
- Clash:cCwPyb83

# proxies åˆ—è¡¨: ç”¨äºå®šä¹‰å†…ç½®æˆ–æ‰‹åŠ¨çš„èŠ‚ç‚¹ï¼Œè§£å†³ "proxy [ç›´è¿] not found" é”™è¯¯
proxies:
  - {name: ç›´è¿, type: direct}
  - {name: æ‹’ç», type: reject}

# -------------------------------------------------------
# ç­–ç•¥ç»„å®šä¹‰ (æ ¸å¿ƒåŠ¨æ€åˆ†ç»„é€»è¾‘ï¼Œéå¸¸å¼ºå¤§)
# -------------------------------------------------------

proxy-groups:

  - name: "ğŸš€ PROXY"
    type: select
    proxies: ["â™»ï¸ è‡ªåŠ¨é€‰æ‹©", "â›‘ï¸ æ•…éšœè½¬ç§»", "âš–ï¸ è´Ÿè½½å‡è¡¡", "ğŸ‡ºğŸ‡¸ ç¾å›½èŠ‚ç‚¹", "ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡èŠ‚ç‚¹", "ğŸ‡¹ğŸ‡¼ å°æ¹¾èŠ‚ç‚¹", "ğŸ‡­ğŸ‡° é¦™æ¸¯èŠ‚ç‚¹", "ğŸ‡¯ğŸ‡µ æ—¥æœ¬èŠ‚ç‚¹", "ğŸŒ å…¶ä»–åœ°åŒº", DIRECT]

  # --- åŠŸèƒ½æ€§åˆ†ç»„ ---

  - name: "âš–ï¸ è´Ÿè½½å‡è¡¡"
    type: load-balance
    strategy: consistent-hashing # ç­–ç•¥: ç¡®ä¿åŒä¸€åŸŸåå§‹ç»ˆå‘½ä¸­åŒä¸€èŠ‚ç‚¹ï¼Œä»¥ç»´æŒä¼šè¯ç¨³å®š
    url: https://www.gstatic.com/generate_204 # å¥åº·æ£€æŸ¥ï¼Œç”¨äºå‰”é™¤ä¸å¯ç”¨çš„èŠ‚ç‚¹
    interval: 300
    use: [main-subscription] # ä½¿ç”¨è®¢é˜…ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹è¿›è¡Œè´Ÿè½½å‡è¡¡
    filter: "(?i)US|United States|ç¾å›½|ç¾" # åªåœ¨ç¾å›½èŠ‚ç‚¹é—´è¿›è¡Œè´Ÿè½½å‡è¡¡

  - name: "â™»ï¸ è‡ªåŠ¨é€‰æ‹©"
    type: url-test
    url: https://www.gstatic.com/generate_204
    interval: 300
    use: [main-subscription]

  - name: "â›‘ï¸ æ•…éšœè½¬ç§»"
    type: fallback
    url: https://www.gstatic.com/generate_204
    interval: 300
    use: [main-subscription]

  # --- åŠ¨æ€åŒºåŸŸåˆ†ç»„ ---

  - name: "ğŸ‡ºğŸ‡¸ ç¾å›½èŠ‚ç‚¹"
    type: url-test
    url: https://www.gstatic.com/generate_204
    interval: 300
    use: [main-subscription]
    filter: "(?i)US|United States|ç¾å›½|ç¾"

  - name: "ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡èŠ‚ç‚¹"
    type: url-test
    url: https://www.gstatic.com/generate_204
    interval: 300
    use: [main-subscription]
    filter: "(?i)SG|Singapore|æ–°åŠ å¡|å¡"

  - name: "ğŸ‡¹ğŸ‡¼ å°æ¹¾èŠ‚ç‚¹"
    type: url-test
    url: https://www.gstatic.com/generate_204
    interval: 300
    use: [main-subscription]
    filter: "(?i)TW|Taiwan|å°æ¹¾|è‡ºæ¹¾|å°"

  - name: "ğŸ‡­ğŸ‡° é¦™æ¸¯èŠ‚ç‚¹"
    type: url-test
    url: https://www.gstatic.com/generate_204
    interval: 300
    use: [main-subscription]
    filter: "(?i)HK|Hong Kong|é¦™æ¸¯|æ¸¯"

  - name: "ğŸ‡¯ğŸ‡µ æ—¥æœ¬èŠ‚ç‚¹"
    type: url-test
    url: https://www.gstatic.com/generate_204
    interval: 300
    use: [main-subscription]
    filter: "(?i)JP|Japan|æ—¥æœ¬|æ—¥"

  - name: "ğŸŒ å…¶ä»–åœ°åŒº"
    type: url-test
    url: https://www.gstatic.com/generate_204
    interval: 300
    use: [main-subscription]
    filter: "(?i)^(?!.*(US|United States|ç¾å›½|ç¾||SG|Singapore|æ–°åŠ å¡|å¡|TW|Taiwan|å°æ¹¾|è‡ºæ¹¾|å°|HK|Hong Kong|é¦™æ¸¯|æ¸¯|JP|Japan|æ—¥æœ¬|æ—¥)).*$"

  # --- ä¸šåŠ¡åˆ†æµç»„ ---

  - name: Block
    type: select
    proxies: ["æ‹’ç»", "ç›´è¿"]

  - name: AI
    type: select
    proxies: ["ğŸ‡ºğŸ‡¸ ç¾å›½èŠ‚ç‚¹", "â›‘ï¸ æ•…éšœè½¬ç§»", "ğŸš€ PROXY"]

  - name: Youtube
    type: select
    proxies: ["â™»ï¸ è‡ªåŠ¨é€‰æ‹©", "â›‘ï¸ æ•…éšœè½¬ç§»", "ğŸš€ PROXY", "ç›´è¿"]

  - name: "ğŸ“º Streaming"
    type: select
    proxies: ["â™»ï¸ è‡ªåŠ¨é€‰æ‹©", "â›‘ï¸ æ•…éšœè½¬ç§»", "ğŸš€ PROXY", "ç›´è¿"]

  - name: GitHub
    type: select
    proxies: ["â™»ï¸ è‡ªåŠ¨é€‰æ‹©", "â›‘ï¸ æ•…éšœè½¬ç§»", "ğŸš€ PROXY", "ç›´è¿"]

  - name: Apple
    type: select
    proxies: ["ç›´è¿", "ğŸš€ PROXY"]

  - name: Microsoft
    type: select
    proxies: ["ğŸš€ PROXY", "ç›´è¿"]

  - name: Games
    type: select
    proxies: ["â™»ï¸ è‡ªåŠ¨é€‰æ‹©", "â›‘ï¸ æ•…éšœè½¬ç§»", "ğŸš€ PROXY", "ç›´è¿"]

  - name: CloudStorage
    type: select
    proxies: ["ç›´è¿", "ğŸš€ PROXY"]

  - name: å›½å¤–
    type: select
    proxies: ["ğŸš€ PROXY", "ç›´è¿"]

  - name: å›½å†…
    type: select
    proxies: ["ç›´è¿", "ğŸš€ PROXY"]

  - name: å…¶ä»–
    type: select
    proxies: ["ğŸš€ PROXY", "ç›´è¿"]

# è§„åˆ™å¼•æ“ & è§„åˆ™é›†
rule-anchor:
  common: &common {type: http, interval: 86400, behavior: classical, format: text}
  ip_common: &ip_common {type: http, interval: 86400, behavior: ipcidr, format: text}

rules:
  # ================= LAN & Reserved IPs Rules (DIRECT) =================
  - IP-CIDR,0.0.0.0/8,DIRECT
  - IP-CIDR,10.0.0.0/8,DIRECT
  - IP-CIDR,100.64.0.0/10,DIRECT
  - IP-CIDR,127.0.0.0/8,DIRECT
  - IP-CIDR,169.254.0.0/16,DIRECT
  - IP-CIDR,172.16.0.0/12,DIRECT
  - IP-CIDR,192.168.0.0/16,DIRECT
  - IP-CIDR,224.0.0.0/4,DIRECT
  - IP-CIDR,240.0.0.0/4,DIRECT
  - IP-CIDR6,::1/128,DIRECT
  - IP-CIDR6,fe80::/10,DIRECT
  - IP-CIDR6,fc00::/7,DIRECT
  - IP-CIDR6,ff00::/8,DIRECT

  # 1. å¹¿å‘Šæ‹¦æˆª
  - RULE-SET,AdBlock,Block
  - RULE-SET,App-Activation,Block

  # 2. æœ¬åœ° & ç›´è¿
  - RULE-SET,LAN,ç›´è¿
  - RULE-SET,Domestic,å›½å†…
  - RULE-SET,CN-IP,å›½å†…,no-resolve
  - RULE-SET,CN-IP,å›½å†…,no-resolve

  # 3. ç²¾ç»†åŒ–åˆ†æµ (é«˜ä¼˜å…ˆçº§)
  - RULE-SET,AI,AI
  - RULE-SET,Google,å›½å¤–
  - RULE-SET,Youtube,Youtube
  - RULE-SET,GitHub,GitHub
  - RULE-SET,Microsoft,Microsoft
  - RULE-SET,CloudStorage,CloudStorage
  
  # 4. èšåˆè§„åˆ™åˆ†æµï¼ˆæµåª’ä½“ & æ¸¸æˆï¼‰
  - RULE-SET,GlobalMedia,ğŸ“º Streaming
  - RULE-SET,Game,Games

  # 5. é€šç”¨ä»£ç†åå¤‡è§„åˆ™ (åŒ…ç½—ä¸‡è±¡)
  - RULE-SET,PROXY,å›½å¤–

  # 6. GEOIP ä½œä¸ºè¡¥å……
  - GEOIP,LAN,ç›´è¿
  - GEOIP,CN,å›½å†…
  - GEOIP,CN,å›½å†…

  # 7. æœ€ç»ˆåŒ¹é…
  - MATCH,å…¶ä»–

rule-providers:
  # Adblock
  AdBlock: {<<: *common, url: "https://raw.githubusercontent.com/CommonDist/NewRules/master/Adblock/Adblock.list"}
  #App-Activation
  App-Activation: {<<: *common, url: "https://raw.githubusercontent.com/CommonDist/NewRules/master/Special/App-Activation.list"}

  # ===========================
  # PROXY/ ç²¾ç»†åŒ–è§„åˆ™ (æŒ‰éœ€å¼•ç”¨)
  # ===========================
  # --- è¡¥å……è§„åˆ™ (æ¥è‡ªå¤–éƒ¨æº) ---
  AI: {<<: *common, url: "https://raw.githubusercontent.com/CommonDist/Rules/main/AI.list"}
  Google: {<<: *common, url: "https://raw.githubusercontent.com/CommonDist/NewRules/master/PROXY/Google.list"}
  Youtube: {<<: *common, url: "https://raw.githubusercontent.com/CommonDist/NewRules/master/Global-Services/YouTube.list"}
  GitHub: {<<: *common, url: "https://raw.githubusercontent.com/CommonDist/NewRules/master/PROXY/Github.list"}
  Microsoft: {<<: *common, url: "https://raw.githubusercontent.com/CommonDist/NewRules/master/Microsoft.list"}
  GlobalMedia: {<<: *common, url: "https://raw.githubusercontent.com/CommonDist/NewRules/master/GlobalMedia.list"}
  Game: {<<: *common, url: "https://raw.githubusercontent.com/CommonDist/NewRules/master/Game.list"}
  CloudStorage: {<<: *common, url: "https://raw.githubusercontent.com/CommonDist/Rules/main/CloudStorageDiect.list"}

  # --- æ ¹ç›®å½•æ ¸å¿ƒè§„åˆ™ ---
  PROXY: {<<: *common, url: "https://raw.githubusercontent.com/CommonDist/NewRules/master/PROXY.list"}
  Domestic: {<<: *common, url: "https://raw.githubusercontent.com/CommonDist/NewRules/master/Domestic.list"}
  CN-IP: {<<: *ip_common, url: "https://raw.githubusercontent.com/CommonDist/NewRules/master/CN-IP.list"}
  LAN: {<<: *common, url: "https://raw.githubusercontent.com/CommonDist/NewRules/refs/heads/master/Special/Local-LAN.list"}
