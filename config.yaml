# ==============================================================
#
#   Mihomo é«˜çº§è®¢é˜…è½¬æ¢æ¨¡æ¿ (æœ€ç»ˆä¿®æ­£ç‰ˆ - CommonDist ç²¾ç»†æ¨¡å¼)
#
#   è§„åˆ™æº: CommonDist/NewRules (å·²é‡‡ç”¨å­ç›®å½•ç²¾ç»†è§„åˆ™)
#   è¯´æ˜:
#     - æœ¬é…ç½®å·²å®Œå…¨æŒ‰ç…§ CommonDist/NewRules çš„é«˜çº§ç”¨æ³•æ„å»ºï¼Œ
#       é€šè¿‡å¼•ç”¨å­ç›®å½•ä¸‹çš„ç»†åˆ†è§„åˆ™ï¼Œå®ç°äº†å¯¹ä¸åŒåº”ç”¨ç±»å‹çš„ç²¾ç¡®åˆ†æµã€‚
#     - è¿™æ˜¯å®ç°å¤æ‚åˆ†æµç­–ç•¥çš„æœ€ç»ˆã€æœ€æ­£ç¡®ç‰ˆæœ¬ã€‚
#
# ==============================================================

# proxies åˆ—è¡¨: ç”¨äºå®šä¹‰å†…ç½®æˆ–æ‰‹åŠ¨çš„èŠ‚ç‚¹ï¼Œè§£å†³ "proxy [ç›´è¿] not found" é”™è¯¯
proxies:
  - {name: ç›´è¿, type: direct}
  - {name: æ‹’ç», type: reject}

# åŸºç¡€é…ç½®
port: 7890
socks-port: 7891
redir-port: 7892
mixed-port: 7893
tproxy-port: 7895
bind-address: "*"
ipv6: true

allow-lan: true
mode: rule
log-level: warning

unified-delay: true
tcp-concurrent: true
external-controller: 0.0.0.0:9090
secret: ""
external-ui: "/usr/share/openclash/ui"
external-ui-name: metacubexd
keep-alive-interval: 15
keep-alive-idle: 600

geodata-mode: true
geodata-loader: standard
geox-url:
  mmdb: https://testingcf.jsdelivr.net/gh/alecthw/mmdb_china_ip_list@release/lite/Country.mmdb
  geoip: https://testingcf.jsdelivr.net/gh/Loyalsoldier/v2ray-rules-dat@release/geoip.dat
  geosite: https://testingcf.jsdelivr.net/gh/Loyalsoldier/v2ray-rules-dat@release/geosite.dat
  asn: https://testingcf.jsdelivr.net/gh/xishang0128/geoip@release/GeoLite2-ASN.mmdb
geo-auto-update: false # æ˜¯å¦è‡ªåŠ¨æ›´æ–° geodata
geo-update-interval: 24 # æ›´æ–°é—´éš”ï¼Œå•ä½ï¼šå°æ—¶

# ========================
# DNS è®¾ç½® (Fake-IP æ¨¡å¼)
# ========================

dns:
  enable: true
  dns-hijack:
    - tcp://any:53
    - udp://any:53
  listen: 0.0.0.0:7874 # ä¿æŒæ‚¨åŸæœ‰çš„ç›‘å¬ç«¯å£
  ipv6: false # é™¤éæ‚¨çš„ç½‘ç»œç¯å¢ƒå®Œç¾æ”¯æŒIPv6ï¼Œå¦åˆ™å»ºè®®å…³é—­ä»¥å¢åŠ ç¨³å®šæ€§
  enhanced-mode: fake-ip
  fake-ip-range: 198.18.0.1/16

  # é»˜è®¤/å›½å¤–åŸŸåè§£æ (ä½¿ç”¨æ— æ±¡æŸ“çš„ DoH/DoT åŠ å¯†DNS)
  nameserver:
    - https://dns.google/dns-query
    - https://1.1.1.1/dns-query
    - https://dns.alidns.com/dns-query # é˜¿é‡ŒDNSï¼Œå¢åŠ å¹¶å‘æŸ¥è¯¢çš„å¤šæ ·æ€§

  # åå¤‡DNS (å½“ä¸Šè¿°DNSè§£æå¤±è´¥æ—¶ä½¿ç”¨)
  fallback:
    - https://dns.alidns.com/dns-query # é˜¿é‡Œ DoH
    - https://dns.cloudflare.com/dns-query
    - https://dns.google/dns-query

  # DNS åˆ†æµç­–ç•¥ (æ ¸å¿ƒ)
  # ä¸ºç‰¹å®šåŸŸåæŒ‡å®šä¸“é—¨çš„ DNS æœåŠ¡å™¨
  nameserver-policy:
    # åŒ¹é…æ‰€æœ‰å›½å†…åŸŸåï¼Œå¼ºåˆ¶ä½¿ç”¨å›½å†…é«˜é€ŸDNSè¿›è¡Œè§£æ
    'geosite:cn':
      - 223.5.5.5
      - 119.29.29.29
      - 211.136.192.6 # ä¿ç•™ä¸€ä¸ªè¿è¥å•†DNSç”¨äºå›½å†…è§£æ

  # Fake-IP è¿‡æ»¤å™¨ (ç”¨äºç›´è¿æˆ–æœ‰å…¼å®¹æ€§é—®é¢˜çš„åŸŸå)
  fake-ip-filter:
    - '*.lan' # ä¿®æ­£å†™æ³•
    - '*.local' # ä¿®æ­£å†™æ³•
    - geosite:cn # æ¨èä¿ç•™ï¼Œè®©æ‰€æœ‰å›½å†…åŸŸåè·å–çœŸå®IPï¼Œå¢å¼ºç›´è¿å…¼å®¹æ€§

# ========================
# TUN æ¨¡å—
# ========================

tun:
  enable: true
  stack: gvisor
  device: utun
  dns-hijack:
  - 127.0.0.1:53
  endpoint-independent-nat: true
  auto-route: false
  auto-detect-interface: false
  auto-redirect: false
  strict-route: false

sniffer:
  enable: true
  override-destination: true
  sniff:
    QUIC:
      ports:
      - 443
    TLS:
      ports:
      - 443
      - 8443
    HTTP:
      ports:
      - 80
      - 8080-8880
      override-destination: true
  force-domain:
  - "+.netflix.com"
  - "+.nflxvideo.net"
  - "+.amazonaws.com"
  - "+.media.dssott.com"
  skip-domain:
  - "+.apple.com"
  - Mijia Cloud
  - dlg.io.mi.com
  - "+.oray.com"
  - "+.sunlogin.net"
  - "+.push.apple.com"
  parse-pure-ip: true
authentication:
- Clash:cCwPyb83

profile:
  store-selected: true
  store-fake-ip: true

# æ¨¡æ¿å ä½ç¬¦
proxy-providers:
  main-subscription:
    type: http
    url: "URL_PLACEHOLDER"
    interval: 86400 # 24å°æ—¶æ›´æ–°ä¸€æ¬¡
    path: ./proxies/main.yaml
    health-check:
      enable: true
      interval: 600 # 10åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
      url: https://www.gstatic.com/generate_204

# -------------------------------------------------------
# ç­–ç•¥ç»„å®šä¹‰ (æ ¸å¿ƒåŠ¨æ€åˆ†ç»„é€»è¾‘ï¼Œéå¸¸å¼ºå¤§)
# -------------------------------------------------------

proxy-groups:

  - name: "ğŸš€ PROXY"
    type: select
    proxies: ["âš–ï¸ è´Ÿè½½å‡è¡¡", "â™»ï¸ è‡ªåŠ¨é€‰æ‹©", "â›‘ï¸ æ•…éšœè½¬ç§»", "ğŸ‡ºğŸ‡¸ ç¾å›½èŠ‚ç‚¹", "ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡èŠ‚ç‚¹", "ğŸ‡¹ğŸ‡¼ å°æ¹¾èŠ‚ç‚¹", "ğŸ‡­ğŸ‡° é¦™æ¸¯èŠ‚ç‚¹", "ğŸ‡¯ğŸ‡µ æ—¥æœ¬èŠ‚ç‚¹", "ğŸŒ å…¶ä»–åœ°åŒº", DIRECT]

  # --- åŠŸèƒ½æ€§åˆ†ç»„ ---

  - name: "âš–ï¸ è´Ÿè½½å‡è¡¡"
    type: load-balance
    # ç­–ç•¥: ç¡®ä¿åŒä¸€åŸŸåå§‹ç»ˆå‘½ä¸­åŒä¸€èŠ‚ç‚¹ï¼Œä»¥ç»´æŒä¼šè¯ç¨³å®š
    strategy: consistent-hashing
    # å¥åº·æ£€æŸ¥ï¼Œç”¨äºå‰”é™¤ä¸å¯ç”¨çš„èŠ‚ç‚¹
    url: https://www.gstatic.com/generate_204
    interval: 300
    # ä½¿ç”¨è®¢é˜…ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹è¿›è¡Œè´Ÿè½½å‡è¡¡
    use: [main-subscription]
    filter: "(?i)US|United States|ç¾å›½|ç¾" # åªåœ¨ç¾å›½èŠ‚ç‚¹é—´è¿›è¡Œè´Ÿè½½å‡è¡¡

  - name: "â™»ï¸ è‡ªåŠ¨é€‰æ‹©"
    type: url-test
    url: https://www.gstatic.com/generate_204
    interval: 300
    use: [main-subscription]
  - name: "â›‘ï¸ æ•…éšœè½¬ç§»"
    type: fallback
    url: https://www.gstatic.com/generate_204
    interval: 300
    use: [main-subscription]

  # --- åŠ¨æ€åŒºåŸŸåˆ†ç»„ ---

  - name: "ğŸ‡ºğŸ‡¸ ç¾å›½èŠ‚ç‚¹"
    type: url-test
    url: https://www.gstatic.com/generate_204
    interval: 300
    use: [main-subscription]
    filter: "(?i)US|United States|ç¾å›½|ç¾"
  - name: "ğŸ‡¸ğŸ‡¬ æ–°åŠ å¡èŠ‚ç‚¹"
    type: url-test
    url: https://www.gstatic.com/generate_204
    interval: 300
    use: [main-subscription]
    filter: "(?i)SG|Singapore|æ–°åŠ å¡|å¡"
  - name: "ğŸ‡¹ğŸ‡¼ å°æ¹¾èŠ‚ç‚¹"
    type: url-test
    url: https://www.gstatic.com/generate_204
    interval: 300
    use: [main-subscription]
    filter: "(?i)TW|Taiwan|å°æ¹¾|è‡ºæ¹¾|å°"
  - name: "ğŸ‡­ğŸ‡° é¦™æ¸¯èŠ‚ç‚¹"
    type: url-test
    url: https://www.gstatic.com/generate_204
    interval: 300
    use: [main-subscription]
    filter: "(?i)HK|Hong Kong|é¦™æ¸¯|æ¸¯"
  - name: "ğŸ‡¯ğŸ‡µ æ—¥æœ¬èŠ‚ç‚¹"
    type: url-test
    url: https://www.gstatic.com/generate_204
    interval: 300
    use: [main-subscription]
    filter: "(?i)JP|Japan|æ—¥æœ¬|æ—¥"
  - name: "ğŸŒ å…¶ä»–åœ°åŒº"
    type: url-test
    url: https://www.gstatic.com/generate_204
    interval: 300
    use: [main-subscription]
    filter: "(?i)^(?!.*(US|United States|ç¾å›½|ç¾||SG|Singapore|æ–°åŠ å¡|å¡|TW|Taiwan|å°æ¹¾|è‡ºæ¹¾|å°|HK|Hong Kong|é¦™æ¸¯|æ¸¯|JP|Japan|æ—¥æœ¬|æ—¥)).*$"

  # --- ä¸šåŠ¡åˆ†æµç»„ ---

  - name: Block
    è¾“å…¥: select
    proxies: [REJECT, DIRECT]
  - name: AI
    è¾“å…¥: select
    proxies: ["ğŸš€ PROXY", DIRECT]
  - name: "ğŸ“º Streaming"
    è¾“å…¥: select
    proxies: ["ğŸš€ PROXY", DIRECT]
  - name: GitHub
    è¾“å…¥: select
    proxies: ["ğŸš€ PROXY", DIRECT]
  - name: Apple
    è¾“å…¥: select
    proxies: [DIRECTï¼Œ "ğŸš€ PROXY"]
  - name: Microsoft
    è¾“å…¥: select
    proxies: ["ğŸš€ PROXY", DIRECT]
  - name: Games
    è¾“å…¥: select
    proxies: ["ğŸš€ PROXY", DIRECT]
  - name: å›½å¤–
    è¾“å…¥: select
    proxies: ["ğŸš€ PROXY", DIRECT]
  - name: å›½å†…
    è¾“å…¥: select
    proxies: [DIRECTï¼Œ "ğŸš€ PROXY"]
  - name: å…¶ä»–
    è¾“å…¥: select
    proxies: ["ğŸš€ PROXY", DIRECT]

# è§„åˆ™å¼•æ“ & è§„åˆ™é›†
rule-anchor:
  common: &common {type: http, interval: 86400, behavior: classical, format: text}

rules:
  # 1. å¹¿å‘Šæ‹¦æˆª
  - RULE-SET,AdBlock,Block
  - RULE-SET,App-Activation,Block
  # 2. æœ¬åœ° & ç›´è¿
  - RULE-SET,LAN,ç›´è¿
  - RULE-SET,Domestic,å›½å†…
  - RULE-SET,CN-IP,å›½å†…,no-resolve
  # 3. ç²¾ç»†åŒ–åˆ†æµ (é«˜ä¼˜å…ˆçº§)
  - RULE-SET,AI,AI
  - RULE-SET,Google,å›½å¤–
  - RULE-SET,GitHub,GitHub
  - RULE-SET,Microsoft,Microsoft
  # 4. èšåˆè§„åˆ™åˆ†æµï¼ˆæµåª’ä½“ & æ¸¸æˆï¼‰
  - RULE-SET,GlobalMedia,ğŸ“º Streaming
  - RULE-SET,Game,Games
  # 5. é€šç”¨ä»£ç†åå¤‡è§„åˆ™ (åŒ…ç½—ä¸‡è±¡)
  - RULE-SET,PROXY,å›½å¤–
  # 6. GEOIP ä½œä¸ºè¡¥å……
  - GEOIP,LAN,ç›´è¿
  - GEOIP,CN,å›½å†…
  # 7. æœ€ç»ˆåŒ¹é…
  - MATCH,å…¶ä»–

rule-providers:
  # Adblock
  AdBlock: {<<: *common, url: "https://raw.githubusercontent.com/CommonDist/NewRules/master/Adblock/Adblock.list"}
  #App-Activation
  App-Activation: {<<: *common, url: "https://raw.githubusercontent.com/CommonDist/NewRules/master/Special/App-Activation.list"}

  # --- PROXY/ ç²¾ç»†åŒ–è§„åˆ™ (æŒ‰éœ€å¼•ç”¨) ---
  Google: {<<: *common, url: "https://raw.githubusercontent.com/CommonDist/NewRules/master/PROXY/Google.list"}
  Github: {<<: *common, url: "https://raw.githubusercontent.com/CommonDist/NewRules/master/PROXY/Github.list"}
  Microsoft: {<<: *common, url: "https://raw.githubusercontent.com/CommonDist/NewRules/master/Microsoft.list"}
  GlobalMedia: {<<: *common, url: "https://raw.githubusercontent.com/CommonDist/NewRules/master/GlobalMedia.list"}
  Game: {<<: *common, url: "https://raw.githubusercontent.com/CommonDist/NewRules/master/Game.list"}

  # --- æ ¹ç›®å½•æ ¸å¿ƒè§„åˆ™ ---
  PROXY: {<<: *common, url: "https://raw.githubusercontent.com/CommonDist/NewRules/master/PROXY.list"}
  Domestic: {<<: *common, url: "https://raw.githubusercontent.com/CommonDist/NewRules/master/Domestic.list"}
  CN-IP: {<<: *ip_common, url: "https://raw.githubusercontent.com/CommonDist/NewRules/master/CN-IP.list"}
  LAN: {<<: *common, url: "https://raw.githubusercontent.com/CommonDist/NewRules/master/Special/LAN.list"}

  # --- è¡¥å……è§„åˆ™ (æ¥è‡ªå¤–éƒ¨æº) ---
  AI: {<<: *common, url: "https://raw.githubusercontent.com/CommonDist/Rules/main/AI.list"}
