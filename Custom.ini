# ==============================================================
#
#   Mihomo 高级订阅转换模板 (最终修正版 V2 - CommonDist 精细模式)
#
#   规则源: CommonDist/NewRules (已采用子目录精细规则)
#   说明:
#     - 本配置已完全按照 CommonDist/NewRules 的高级用法构建，
#       通过引用子目录下的细分规则，实现了对不同应用类型的精确分流。
#     - 这是实现复杂分流策略的最终、最正确版本。
#
# ==============================================================

# 基础配置
port: 7890
socks-port: 7891
redir-port: 7892
mixed-port: 7893
tproxy-port: 7895
ipv6: true

allow-lan: true
mode: rule
log-level: info

unified-delay: true
tcp-concurrent: true
external-controller: 0.0.0.0:9090
secret: ""
external-ui: "/usr/share/openclash/ui"
external-ui-name: metacubexd
keep-alive-interval: 15
keep-alive-idle: 600

geox-url:
  mmdb: https://testingcf.jsdelivr.net/gh/alecthw/mmdb_china_ip_list@release/lite/Country.mmdb
  geoip: https://testingcf.jsdelivr.net/gh/Loyalsoldier/v2ray-rules-dat@release/geoip.dat
  geosite: https://testingcf.jsdelivr.net/gh/Loyalsoldier/v2ray-rules-dat@release/geosite.dat
  asn: https://testingcf.jsdelivr.net/gh/xishang0128/geoip@release/GeoLite2-ASN.mmdb
geo-auto-update: false # 是否自动更新 geodata
geo-update-interval: 24 # 更新间隔，单位：小时

# ========================
# DNS 设置 (Fake-IP 模式)
# ========================

dns:
  enable: true
  listen: 0.0.0.0:7874 # 保持您原有的监听端口
  ipv6: false # 除非您的网络环境完美支持IPv6，否则建议关闭以增加稳定性
  enhanced-mode: fake-ip
  fake-ip-range: 198.18.0.1/16

  # 默认/国外域名解析 (使用无污染的 DoH/DoT 加密DNS)
  nameserver:
    - https://dns.google/dns-query
    - https://1.1.1.1/dns-query
    - https://dns.alidns.com/dns-query # 阿里DNS，增加并发查询的多样性

  # 后备DNS (当上述DNS解析失败时使用)
  fallback:
    - https://dns.alidns.com/dns-query # 阿里 DoH
    - https://dns.cloudflare.com/dns-query
    - https://dns.google/dns-query

  # DNS 分流策略 (核心)
  # 为特定域名指定专门的 DNS 服务器
  nameserver-policy:
    # 匹配所有国内域名，强制使用国内高速DNS进行解析
    'geosite:cn':
      - 223.5.5.5
      - 119.29.29.29
      - 211.136.192.6 # 保留一个运营商DNS用于国内解析

  # Fake-IP 过滤器 (用于直连或有兼容性问题的域名)
  fake-ip-filter:
    - '*.lan' # 修正写法
    - '*.local' # 修正写法
    - geosite:cn # 推荐保留，让所有国内域名获取真实IP，增强直连兼容性

# ========================
# TUN 模块
# ========================

tun:
  enable: true
  stack: gvisor
  device: utun
  dns-hijack:
  - 127。0。0。1:53
  endpoint-independent-nat: true
  auto-route: false
  auto-detect-interface: false
  auto-redirect: false
  strict-route: false

profile:
  store-selected: true
  store-fake-ip: true

# 模板占位符
proxy-providers:
  main-subscription:
    type: http
    url: "URL_PLACEHOLDER"
    interval: 86400 # 24小时更新一次
    path: ./proxies/main.yaml
    health-check:
      enable: true
      interval: 600 # 10分钟检查一次
      url: https://www.gstatic.com/generate_204

# -------------------------------------------------------
# 策略组定义 (核心动态分组逻辑，非常强大)
# -------------------------------------------------------

proxy-groups:
  - name: "🚀 PROXY"
    type: select
    proxies: ["♻️ 自动选择", "⛑️ 故障转移", "🇺🇸 美国节点", "🇸🇬 新加坡节点", "🇹🇼 台湾节点", "🇭🇰 香港节点", "🇯🇵 日本节点", "🌍 其他地区", DIRECT]
  - name: "♻️ 自动选择"
    type: url-test
    url: https://www.gstatic.com/generate_204
    interval: 300
    use: [main-subscription]
  - name: "⛑️ 故障转移"
    type: fallback
    url: https://www.gstatic.com/generate_204
    interval: 300
    use: [main-subscription]
  - name: "🇺🇸 美国节点"
    type: url-test
    url: https://www.gstatic.com/generate_204
    interval: 300
    use: [main-subscription]
    filter: "(?i)US|United States|美国|美"
  - name: "🇸🇬 新加坡节点"
    type: url-test
    url: https://www.gstatic.com/generate_204
    interval: 300
    use: [main-subscription]
    filter: "(?i)SG|Singapore|新加坡|坡"
  - name: "🇹🇼 台湾节点"
    type: url-test
    url: https://www.gstatic.com/generate_204
    interval: 300
    use: [main-subscription]
    filter: "(?i)TW|Taiwan|台湾|臺湾|台"
  - name: "🇭🇰 香港节点"
    type: url-test
    url: https://www.gstatic.com/generate_204
    interval: 300
    use: [main-subscription]
    filter: "(?i)HK|Hong Kong|香港|港"
  - name: "🇯🇵 日本节点"
    type: url-test
    url: https://www.gstatic.com/generate_204
    interval: 300
    use: [main-subscription]
    filter: "(?i)JP|Japan|日本|日"
  - name: "🌍 其他地区"
    type: url-test
    url: https://www.gstatic.com/generate_204
    interval: 300
    use: [main-subscription]
    filter: "(?i)^(?!.*(US|United States|美国|美||SG|Singapore|新加坡|坡|TW|Taiwan|台湾|臺湾|台|HK|Hong Kong|香港|港|JP|Japan|日本|日)).*$"
  - name: Block
    type: select
    proxies: [REJECT, DIRECT]
  - name: AI
    type: select
    proxies: ["🚀 PROXY", DIRECT]
  - name: "📺 Streaming"
    type: select
    proxies: ["🚀 PROXY", DIRECT]
  - name: GitHub
    type: select
    proxies: ["🚀 PROXY", DIRECT]
  - name: Apple
    type: select
    proxies: [DIRECT, "🚀 PROXY"]
  - name: Microsoft
    type: select
    proxies: ["🚀 PROXY", DIRECT]
  - name: Games
    type: select
    proxies: ["🚀 PROXY", DIRECT]
  - name: 国外
    type: select
    proxies: ["🚀 PROXY", DIRECT]
  - name: 国内
    type: select
    proxies: [DIRECT, "🚀 PROXY"]
  - name: 其他
    type: select
    proxies: ["🚀 PROXY", DIRECT]

# 规则引擎 & 规则集
rule-anchor:
  common: &common {type: http, interval: 86400, behavior: classical, format: text}

rules:
  # 1. 广告拦截
  - RULE-SET,AdBlock,Block
  # 2. 本地 & 直连
  - RULE-SET,LAN,直连
  - RULE-SET,Direct,国内
  # 3. 特定应用分流
  - RULE-SET,Apple,Apple
  - RULE-SET,Microsoft,Microsoft
  - RULE-SET,Google,国外
  - RULE-SET，GitHub,GitHub
  - RULE-SET，AI，AI
  # 4. 游戏
  - RULE-SET,Game,Games
  # 5. 流媒体 (精细化)
  - RULE-SET，Netflix,📺 Streaming
  - RULE-SET，Disney，📺 Streaming
  - RULE-SET，YouTube,📺 Streaming
  - RULE-SET,Spotify,📺 Streaming
  - RULE-SET,Bahamut,📺 Streaming
  # 6. 全球服务 (作为通用国外流量)
  - RULE-SET,Global,国外
  # 7. GEOIP 作为补充
  - GEOIP,LAN,直连
  - GEOIP，CN，国内
  # 8. 最终匹配
  - MATCH,其他

rule-providers:
  # 以下是来自 CommonDist/NewRules 仓库子目录的精确链接
  # Adblock
  AdBlock: {<<: *common, url: "https://raw.githubusercontent.com/CommonDist/NewRules/main/Adblock/Ad.list"}
  # Domestic-Services
  Direct: {<<: *common, url: "https://raw.githubusercontent.com/CommonDist/NewRules/main/Domestic-Services/Direct.list"}
  # Special
  LAN: {<<: *common, url: "https://raw.githubusercontent.com/CommonDist/NewRules/main/Special/LAN.list"}
  # Apple
  Apple: {<<: *common, url: "https://raw.githubusercontent.com/CommonDist/NewRules/main/Apple/Apple.list"}
  # Global-Services (精细化)
  Microsoft: {<<: *common, url: "https://raw.githubusercontent.com/CommonDist/NewRules/main/Global-Services/Microsoft.list"}
  Google: {<<: *common, url: "https://raw.githubusercontent.com/CommonDist/NewRules/main/Global-Services/Google.list"}
  GitHub: {<<: *common, url: "https://raw.githubusercontent.com/CommonDist/NewRules/main/Global-Services/GitHub.list"}
  AI: {<<: *common, url: "https://raw.githubusercontent.com/CommonDist/NewRules/main/Global-Services/AI.list"}
  Netflix: {<<: *common, url: "https://raw.githubusercontent.com/CommonDist/NewRules/main/Global-Services/Netflix.list"}
  Disney: {<<: *common, url: "https://raw.githubusercontent.com/CommonDist/NewRules/main/Global-Services/Disney.list"}
  YouTube: {<<: *common, url: "https://raw.githubusercontent.com/CommonDist/NewRules/main/Global-Services/YouTube.list"}
  Spotify: {<<: *common, url: "https://raw.githubusercontent.com/CommonDist/NewRules/main/Global-Services/Spotify.list"}
  # Game
  Game: {<<: *common, url: "https://raw.githubusercontent.com/CommonDist/NewRules/main/Game/Game.list"}
  # CCC-Global (作为通用的国外规则补充)
  Global: {<<: *common, url: "https://raw.githubusercontent.com/CommonDist/NewRules/main/CCC-Global/Global.list"}
  # CCC-CN
  Bahamut: {<<: *common, url: "https://raw.githubusercontent.com/CommonDist/NewRules/main/CCC-CN/Bahamut.list"} # 巴哈姆特，虽然在CCC-CN下，但通常需要代理
