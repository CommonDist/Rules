# ==============================================================
#
#   Mihomo 高级订阅转换模板 (CommonDist 精细模式)
#
#   规则源: CommonDist/NewRules (已采用子目录精细规则)
#   说明:
#     - 引用子目录下的细分规则，实现了对不同应用类型的精确分流；
#     - 引用包罗万象的 PROXY.list 兜底。
#
# ==============================================================

# 模板占位符
proxy-providers:
  main-subscription:
    type: http
    url: "URL_PLACEHOLDER"
    interval: 86400 # 24小时更新一次
    path: ./proxies/main.yaml
    health-check:
      enable: true
      interval: 600 # 10分钟检查一次
      url: https://www.gstatic.com/generate_204

https://github.com/CommonDist

authentication:
  - Clash:cCwPyb83


# -------------------------------------------------------
# 策略组定义 (核心动态分组逻辑，非常强大)
# -------------------------------------------------------

proxy-groups:

  - name: "🚀 PROXY"
    type: select
    proxies: ["♻️ 自动选择", "⛑️ 故障转移", "⚖️ 负载均衡", "🇺🇸 美国", "🇸🇬 新加坡", "🇭🇰 香港", "🇯🇵 日本", "🇹🇼 台湾", "🌍 其他地区"]

  # --- 功能性分组 ---

  - name: "⚖️ 负载均衡"
    type: load-balance
    strategy: consistent-hashing # 策略: 确保同一域名始终命中同一节点，以维持会话稳定
    url: https://www.gstatic.com/generate_204 # 健康检查，用于剔除不可用的节点
    interval: 120
    use: [main-subscription] # 使用订阅中的所有节点进行负载均衡
    proxies:
      - "🇺🇸 美国"
      - "🇳🇱 荷兰"
      - "🇯🇵 日本"
      - "🇭🇰 香港"
      - "🇸🇬 新加坡"

  - name: "♻️ 自动选择"
    type: url-test
    url: https://www.gstatic.com/generate_204
    interval: 120
    use: [main-subscription]

  - name: "⛑️ 故障转移"
    type: fallback
    url: https://www.gstatic.com/generate_204
    interval: 120
    use: [main-subscription]

  # --- 动态区域分组 ---

  - name: "🇺🇸 美国"
    type: url-test
    url: https://www.gstatic.com/generate_204
    interval: 120
    use: [main-subscription]
    filter: "(?i)🇺🇸|\bUS\b|United States|美国|美"

  - name: "🇳🇱 荷兰"
    type: url-test
    url: https://www.gstatic.com/generate_204
    interval: 120
    use: [main-subscription]
    filter: "(?i)🇳🇱|NL|Netherlands|荷兰|荷"

  - name: "🇸🇬 新加坡"
    type: url-test
    url: https://www.gstatic.com/generate_204
    interval: 120
    use: [main-subscription]
    filter: "(?i)🇸🇬|SG|Singapore|新加坡|坡"

  - name: "🇯🇵 日本"
    type: url-test
    url: http://www.google.co.jp/generate_204
    interval: 120
    use: [main-subscription]
    filter: "(?i)🇯🇵|JP|Japan|日本|日"

  - name: "🇭🇰 香港"
    type: url-test
    url: http://www.google.com.hk/generate_204
    interval: 120
    use: [main-subscription]
    filter: "(?i)🇭🇰|HK|Hong Kong|香港|港"

  - name: "🇹🇼 台湾"
    type: url-test
    url: https://www.gstatic.com/generate_204
    interval: 120
    use: [main-subscription]
    filter: "(?i)🇹🇼|TW|Taiwan|台湾|臺湾|台"

  - name: "🌍 其他地区"
    type: url-test
    url: https://www.gstatic.com/generate_204
    interval: 120
    use: [main-subscription]
    filter: "(?i)^(?!.*(\bUS\b|United States|美国|美|SG|Singapore|新加坡|坡|TW|Taiwan|台湾|臺湾|台|HK|Hong Kong|香港|港|JP|Japan|日本|日|NL|Netherlands|荷兰|荷)).*$"

  # --- 业务分流组 ---

  - name: Block
    type: select
    proxies: [REJECT, DIRECT]

  - name: NTP
    type: select
    proxies: [DIRECT, "🚀 PROXY", "♻️ 自动选择"]

  - name: AI
    type: select
    proxies: ["🇺🇸 美国", "⛑️ 故障转移", "🚀 PROXY"]

  - name: Google
    type: select
    proxies: ["🇺🇸 美国", "⛑️ 故障转移", "🚀 PROXY"]

  - name: Youtube
    type: select
    proxies: ["🇺🇸 美国", "♻️ 自动选择", "⛑️ 故障转移", "🚀 PROXY", DIRECT]

  - name: GitHub
    type: select
    proxies: ["♻️ 自动选择", "⛑️ 故障转移", "🚀 PROXY", DIRECT]

  - name: Telegram
    type: select
    proxies: ["🇺🇸 美国", "♻️ 自动选择"]

  - name: Apple
    type: select
    proxies: [DIRECT, "🚀 PROXY"]

  - name: Microsoft
    type: select
    proxies: ["🚀 PROXY", DIRECT]

  - name: "📺 Streaming"
    type: select
    proxies: ["♻️ 自动选择", "⛑️ 故障转移", "🚀 PROXY", DIRECT]

  - name: Games
    type: select
    proxies: ["♻️ 自动选择", "⛑️ 故障转移", "🚀 PROXY", DIRECT]

  - name: CustomProxy
    type: select
    proxies: ["🚀 PROXY", DIRECT]

  - name: 直连优先
    type: select
    proxies: [DIRECT, "🚀 PROXY"]

  - name: 国外
    type: select
    proxies: ["🚀 PROXY", DIRECT]

  - name: 国内
    type: select
    proxies: [DIRECT, "🚀 PROXY"]

  - name: 其他
    type: select
    proxies: ["🚀 PROXY", DIRECT]

rules:
  # 1. 局域网与保留地址规则 (必须放在最前面)
  - IP-CIDR,0.0.0.0/8,DIRECT,no-resolve
  - IP-CIDR,10.0.0.0/8,DIRECT,no-resolve
  - IP-CIDR,100.64.0.0/10,DIRECT,no-resolve
  - IP-CIDR,127.0.0.0/8,DIRECT,no-resolve
  - IP-CIDR,169.254.0.0/16,DIRECT,no-resolve
  - IP-CIDR,172.16.0.0/12,DIRECT,no-resolve
  - IP-CIDR,192.168.0.0/16,DIRECT,no-resolve
  - IP-CIDR,224.0.0.0/4,DIRECT,no-resolve
  - IP-CIDR,240.0.0.0/4,DIRECT,no-resolve
  - IP-CIDR6,::1/128,DIRECT,no-resolve
  - IP-CIDR6,fc00::/7,DIRECT,no-resolve
  - IP-CIDR6,fd00::/8,DIRECT,no-resolve
  - IP-CIDR6,fe80::/10,DIRECT,no-resolve
  - IP-CIDR6,ff00::/8,DIRECT,no-resolve

  # NTP 服务最高优先级
  - RULE-SET,NTP,NTP

  # 2. 广告拦截
  - RULE-SET,AdBlock,Block
  - RULE-SET,App-Activation,Block

  # 3. 私有 & 直连
  - RULE-SET,Private,DIRECT
  - RULE-SET,Direct,国内

  # 4. 精细化分流 (高优先级)
  - GEOIP,CN,DIRECT # GEOIP 作为补充
  - GEOSITE,apple-cn,DIRECT                 # 直连苹果中国区服务
  - RULE-SET,AI,AI
  - RULE-SET,Google,Google
  - RULE-SET,GoogleDomian，Google
  - RULE-SET,GitHub，GitHub
  - RULE-SET,Youtube，Youtube
  - RULE-SET,Microsoft，Microsoft
  - RULE-SET,CustomProxy,CustomProxy
  - RULE-SET，CustomDiect，直连优先
  - GEOSITE,telegram,Telegram

  # 5. 聚合规则分流（流媒体 & 游戏）
  - RULE-SET,GlobalMedia,📺 Streaming
  - RULE-SET,Game,Games

  # 6. 通用代理后备规则 (包罗万象)
  - RULE-SET,PROXY,国外

  # 7. 最终匹配
  - MATCH,其他

# ==========================================
# YAML Anchors (Templates) 规则引擎 & 规则集
# ==========================================

rule-anchor:
  ip: &ip {type: http, interval: 86400, behavior: ipcidr, format: text}
  domain: &domain {type: http, interval: 86400, behavior: domain, format: text}
  class: &class {type: http, interval: 86400, behavior: classical, format: text}

rule-providers:
  # --- 私有地址规则 ---
  Private: {<<: *domain, url: "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/private.txt", path: "./rules/Private.yaml"}

  # --- 直连规则 ---
  Direct: {<<: *domain, url: "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/direct.txt", path: "./rules/Direct.yaml"}

  # --- 广告屏蔽 ---
  AdBlock: {<<: *domain, url: "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/reject.txt", path: "./rules/Adblock.yaml"}
  
  #App-Activation
  App-Activation: {<<: *domain, url: "https://raw.githubusercontent.com/CommonDist/Rules/main/Data/App-Activation.list", path: "./rules/App-Activation.yaml"}

  # ===========================
  # PROXY/ 精细化规则 (按需引用)
  # ===========================
  NTP: {<<: *domain, url: "https://raw.githubusercontent.com/CommonDist/Rules/main/Data/NTP.list", path: "./rules/NTP.yaml"}
  AI: {<<: *domain, url: "https://raw.githubusercontent.com/CommonDist/Rules/main/Data/AI.list", path: "./rules/AI.yaml"}
  Google: {<<: *domain, url: "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/google.txt", path: "./rules/Google.yaml"}
  GoogleDomian: {<<: *domain, url: "https://raw.githubusercontent.com/CommonDist/Rules/refs/heads/main/Data/GoogleDomian.list", path: "./rules/GoogleDomian.yaml"}
  GitHub: {<<: *class, url: "https://raw.githubusercontent.com/CommonDist/NewRules/master/PROXY/Github.list", path: "./rules/Github.yaml"}
  Youtube: {<<: *domain, url: "https://raw.githubusercontent.com/CommonDist/Rules/main/Data/YouTube.list", path: "./rules/YouTube.yaml"}
  Apple: {<<: *domain, url: "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/apple.txt", path: "./rules/Apple.yaml"}
  Microsoft: {<<: *class, url: "https://raw.githubusercontent.com/CommonDist/NewRules/master/Microsoft.list", path: "./rules/Microsoft.yaml"}
  GlobalMedia: {<<: *domain, url: "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/gfw.txt", path: "./rules/GlobalMedia.yaml"}
  Game: {<<: *domain, url: "https://raw.githubusercontent.com/CommonDist/Rules/main/Data/Game.list", path: "./rules/Game.yaml"}

  # --- 自定义维护列表 ---
  CustomProxy: {<<: *domain, url: "https://raw.githubusercontent.com/CommonDist/Rules/main/Data/CustomProxy.list", path: "./rules/CustomProxy.yaml"}
  CustomDiect: {<<: *domain, url: "https://raw.githubusercontent.com/CommonDist/Rules/main/Data/CustomDiect.list", path: "./rules/CustomDiect.yaml"}

  # --- 根目录核心规则 ---
  PROXY: {<<: *domain, url: "https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/proxy.txt", path: "./rules/Proxy.yaml"}
